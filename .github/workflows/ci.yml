---
name: ci

'on':
  push:
    branches:
      - '**'

permissions:
  contents: read

jobs:
  ci:
    runs-on: [self-hosted, dev]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extras / Count Lines of Source Code
        run: cloc HEAD --exclude-dir=package-lock.json

      - name: Install requirements
        run: npm ci

      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      # Build [Dev] (and Deploy)
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      - name: Build (dev)
        if: github.ref == 'refs/heads/dev'
        run: npm run build:dev

      - name: Deploy (dev) [Copy static files over]
        if: github.ref == 'refs/heads/dev'
        run: rm -rf /var/www/app/* && mv build/* /var/www/app/

      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      # Lint
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      - name: Lint
        run: npm run lint

      - name: Check
        run: npm run check

      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      # Build [Prod] (and Upload binary)
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      - name: Build (prod)
        if: github.ref == 'refs/heads/prod'
        env:
          GH_TOKEN: ${{ github.token }}
        permissions:
          contents: write
        run: set -o pipefail; make build/prod build/compress

      - name: Upload artifacts
        if: github.ref == 'refs/heads/prod'
        env:
          GH_TOKEN: ${{ github.token }}
        permissions:
          contents: write
        run: set -o pipefail; make build/upload
